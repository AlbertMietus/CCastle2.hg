{# (C) Albert Mietus, 2023. Part of Castle/CCastle project #}

{# parameters: ``protocols``: PTH.Sequence[aigr.EventProtocol]
#}

{%- import "CastleMacros.jinja2" as m -%}

{%- macro Str_or_Type(t) -%}
  {%- if t is string -%}
    "{{t}}"
  {%- else -%}
    {{t.__name__}}
  {%- endif -%}
{%- endmacro -%}

{%- for proto in protocols %}
  {{- m.ProtocolName(proto.name) }} = buildin.CC_B_Protocol(name="{{ proto.name }}",
  {% if proto.typedParameters  %}
                                parameters=(
    {% for parm in proto.typedParameters %}
                                    ('{{ parm.name}}', {{ Str_or_Type(parm.type) }}),
    {% endfor %}
                                ), {#- XXX ToDo: parms: tuple, namedType, strings, ... (see event -- use macro?) #}

  {% endif %}
                                kind=buildin.{{proto.kind}},
                                inherit_from={{m.ProtocolName(proto.based_on.name)}},
                                events=[])

  {% for e in proto.events %}
    {{- m.ProtocolName(proto.name) }}.events.append(buildin.CC_B_P_EventID(name="{{- e.name -}}",
                                seqNo={{- m.EventIndexName(proto.name, e.name) }},
                                part_of={{ m.ProtocolName(proto.name) }}))
  {% endfor %} {#- event #}

{% endfor %} {#- protocols #}
